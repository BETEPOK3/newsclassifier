<!DOCTYPE html>
<html lang="ru">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        {% include 'shared/links.html' %}
        <meta http-equiv="Content-Type" content="text/html; Charset=UTF-8" />
        <title>Index</title>
    </head>
    <body id="page-top">
        <div id="wrapper">
            {% include 'shared/left_nav.html' %}
            <div class="d-flex flex-column" id="content-wrapper">
                <div id="content" class="main-div">
                    {% include 'shared/top_nav.html' %}
                    <div>
                        <div>
                            <label for="">Название:</label>
                            <input class="col-8" name="article_title" id="article_title" placeholder="Название" minlength="1" type="text" />
                        </div>
                        <div>
                            <label for="">Автор:</label>
                            <input class="col-8" name="article_author" id="article_author" placeholder="Автор" minlength="1" type="text" />
                        </div>
                        <div>
                            <label for="">Категории:</label>
                            <input class="col-8" name="article_categories" id="article_categories" placeholder="Категории" minlength="1" type="text" />
                        </div>
                        <div>
                            <label for="">Ключевые слова:</label>
                            <input class="col-8" name="article_keywords" id="article_keywords" placeholder="Ключевые слова" type="text" />
                        </div>
                        <div>
                            <label for="">Дата создания:</label>
                            <input class="col-8" name="article_date" id="article_date" placeholder="Дата создания" min="1970-01-01" max="2023-12-31" type="date" />
                        </div>
                        <div>
                            <label for="">Текст:</label>
                            <input class="col-8" name="article_text" id="article_text" placeholder="Текст" minlength="1" type="text" />
                        </div>
                        <div>
                            <button onclick="send()">Отправить</button>
                        </div>
                        <script type="text/javascript">
                            async function send() {
                                let title = document.getElementById("article_title").value;
                                title = title == "" ? undefined : title;
                                let author = document.getElementById("article_author").value;
                                author = author == "" ? undefined : author;
                                const categories = document.getElementById("article_categories").value;
                                const categories_list = categories.split(";").map((category) => category.trim());
                                const keywords = document.getElementById("article_keywords").value;
                                const keywords_list = keywords.split(";").map((keyword) => keyword.trim());
                                let date = document.getElementById("article_date").value;
                                date = date == "" ? undefined : date;
                                let text = document.getElementById("article_text").value;
                                text = text == "" ? undefined : text;

                                let categoriesIsValid = true;
                                let keywordsIsValid = true;

                                for (category of categories_list) {
                                    if (category == "") {
                                        categoriesIsValid = false;
                                    }
                                }

                                if (keywords_list.length > 1) {
                                    for (keyword of keywords_list) {
                                        if (keyword == "") {
                                            keywordsIsValid = false;
                                        }
                                    }
                                }

                                if (title == undefined) {
                                    alert("Поле 'Название' не может быть пустым");
                                } else if (author == undefined) {
                                    alert("Поле 'Автор' не может быть пустым");
                                } else if (categoriesIsValid == false) {
                                    alert("Поле 'Категории' должно быть заполнено, категории должны быть указаны через точку с запятой");
                                } else if (categoriesIsValid == false) {
                                    alert("Ключевые слова должны быть указаны через точку с запятой");
                                } else if (date == undefined) {
                                    alert("Поле 'Дата' должно быть заполнено");
                                } else if (text == undefined) {
                                    alert("Поле 'Текст' не может быть пустым");
                                } else {
                                    const response = await fetch("/article/create", {
                                        method: "POST",
                                        headers: {
                                            Accept: "application/json",
                                            "Content-Type": "application/json",
                                        },
                                        body: JSON.stringify({
                                            article_title: title,
                                            article_author: author,
                                            article_categories: categories_list,
                                            article_keywords: keywords_list,
                                            article_date: date,
                                            article_text: text,
                                        }),
                                    });
                                    if (response.ok) {
                                        const json = await response.json();
                                        window.location.replace("/article/" + json.id);
                                    } else console.log(response);
                                }
                            }
                        </script>
                        <form action="/index" method="get">
                            <button type="submit" class="btn btn-info mt-4">Отмена</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        {% include 'shared/scripts.html' %}
    </body>
</html>
